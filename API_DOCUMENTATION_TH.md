# ระบบจัดการข้อมูล IoT ด้วย Flask - เอกสารหน้าเว็บและ API

เอกสารนี้ให้รายละเอียดของทุกหน้าเว็บ, API endpoints และการทำงานในระบบจัดการข้อมูล IoT ด้วย Flask

## สารบัญ

- [หน้าเว็บ (ส่วนติดต่อผู้ใช้)](#หน้าเว็บ-ส่วนติดต่อผู้ใช้)
- [API Endpoints](#api-endpoints)
- [CRUD API Endpoints](#crud-api-endpoints)
- [การดำเนินการฐานข้อมูล](#การดำเนินการฐานข้อมูล)
- [การจัดการข้อผิดพลาด](#การจัดการข้อผิดพลาด)

---

## หน้าเว็บ (ส่วนติดต่อผู้ใช้)

### 1. หน้าแรก (`/`)

**เส้นทาง:** `GET /`  
**ฟังก์ชัน:** `home()`  
**เทมเพลต:** `templates/index.html`  
**วัตถุประสงค์:** หน้าหลักและแดชบอร์ดของเว็บไซต์

**คุณสมบัติ:**

- ข้อความต้อนรับและภาพรวมของระบบ
- การ์ดนำทางไปยังฟีเจอร์หลัก:
  - ดูอุปกรณ์
  - เพิ่มข้อมูล
  - เข้าถึง API
  - ตรวจสอบสถานะ
- รายการฟีเจอร์และข้อมูล API endpoint
- คำแนะนำการเริ่มต้นใช้งาน

**ขั้นตอนการใช้งาน:** จุดเริ่มต้น → นำทางไปยังฟังก์ชันเฉพาะ

---

### 2. รายการอุปกรณ์ (`/devices`)

**เส้นทาง:** `GET /devices`  
**ฟังก์ชัน:** `list_devices()`  
**เทมเพลต:** `templates/devices.html`  
**วัตถุประสงค์:** แสดงอุปกรณ์ IoT ทั้งหมดพร้อมสถิติสรุป

**คุณสมบัติ:**

- เลย์เอาต์แบบการ์ดแสดงอุปกรณ์แต่ละตัว
- สถิติของอุปกรณ์:
  - จำนวนการอ่านค่าทั้งหมด
  - เวลาที่เห็นล่าสุด
  - อุณหภูมิเฉลี่ย
  - ความชื้นเฉลี่ย
- เข้าถึงรายละเอียดอุปกรณ์อย่างรวดเร็ว
- ปุ่มเพิ่มการอ่านค่าใหม่

**การดำเนินการฐานข้อมูล:**
```sql
SELECT device_id, MAX(timestamp) as last_seen, COUNT(*) as total_readings,
       AVG(temperature) as avg_temperature, AVG(humidity) as avg_humidity
FROM iot_readings GROUP BY device_id ORDER BY last_seen DESC
```

**ขั้นตอนการใช้งาน:** หน้าแรก → ดูอุปกรณ์ → รายละเอียดอุปกรณ์

---

### 3. รายละเอียดอุปกรณ์ (`/device/<device_id>`)

**เส้นทาง:** `GET /device/<device_id>`  
**ฟังก์ชัน:** `view_device(device_id)`  
**เทมเพลต:** `templates/device_detail.html`  
**วัตถุประสงค์:** มุมมองรายละเอียดของการอ่านค่าทั้งหมดสำหรับอุปกรณ์เฉพาะ

**คุณสมบัติ:**

- ตารางการอ่านค่าของอุปกรณ์แบบแบ่งหน้า (20 รายการต่อหน้า)
- รายละเอียดการอ่านค่า: ID, เวลา, อุณหภูมิ, ความชื้น, ข้อมูลเซนเซอร์
- เครื่องมือดู JSON ข้อมูลเซนเซอร์แบบขยายได้
- การดำเนินการแก้ไขและลบสำหรับแต่ละการอ่านค่า
- ตัวควบคุมการแบ่งหน้า
- สถิติเฉพาะของอุปกรณ์

**พารามิเตอร์ URL:**

- `device_id` (จำเป็น): ตัวระบุอุปกรณ์
- `page` (ไม่บังคับ): หมายเลขหน้าสำหรับการแบ่งหน้า

**การดำเนินการฐานข้อมูล:**
```sql
-- ดึงการอ่านค่าแบบแบ่งหน้า
SELECT * FROM iot_readings WHERE device_id = %s 
ORDER BY timestamp DESC LIMIT %s OFFSET %s

-- ดึงจำนวนทั้งหมด
SELECT COUNT(*) as total FROM iot_readings WHERE device_id = %s
```

**ขั้นตอนการใช้งาน:** รายการอุปกรณ์ → รายละเอียดอุปกรณ์ → แก้ไข/ลบการอ่านค่า

---

### 4. สร้างการอ่านค่า (`/create`)

**เส้นทาง:** `GET /create` | `POST /create`  
**ฟังก์ชัน:** `create_reading()`  
**เทมเพลต:** `templates/create.html`  
**วัตถุประสงค์:** แบบฟอร์มสำหรับเพิ่มการอ่านค่าเซนเซอร์ IoT แบบด้วยตนเอง

**คำขอ GET:**

- แสดงแบบฟอร์มสำหรับการป้อนข้อมูลด้วยตนเอง
- ฟิลด์แบบฟอร์ม: device_id, temperature, humidity, sensor_data
- ข้อความช่วยเหลือและตัวอย่าง JSON

**คำขอ POST:**

- ตรวจสอบข้อมูลแบบฟอร์ม
- แยกวิเคราะห์ข้อมูล JSON sensor_data
- แทรกการอ่านค่าใหม่ลงในฐานข้อมูล
- เปลี่ยนเส้นทางไปยังรายละเอียดอุปกรณ์เมื่อสำเร็จ

**การตรวจสอบแบบฟอร์ม:**

- Device ID: จำเป็น, ตัวอักษรและตัวเลขพร้อมขีดล่าง/ขีดกลาง
- อุณหภูมิ: ค่าทศนิยมไม่บังคับ
- ความชื้น: ค่าทศนิยมไม่บังคับ (0-100%)
- ข้อมูลเซนเซอร์: JSON ที่ถูกต้องไม่บังคับ

**การดำเนินการฐานข้อมูล:**
```sql
INSERT INTO iot_readings (device_id, temperature, humidity, sensor_data)
VALUES (%s, %s, %s, %s)
```

**ขั้นตอนการใช้งาน:** หน้าใดก็ได้ → สร้าง → รายละเอียดอุปกรณ์ (ของการอ่านค่าที่สร้าง)

---

### 5. แก้ไขการอ่านค่า (`/edit/<reading_id>`)

**เส้นทาง:** `GET /edit/<reading_id>` | `POST /edit/<reading_id>`  
**ฟังก์ชัน:** `edit_reading(reading_id)`  
**เทมเพลต:** `templates/edit.html`  
**วัตถุประสงค์:** แก้ไขการอ่านค่าเซนเซอร์ IoT ที่มีอยู่

**คำขอ GET:**

- ดึงข้อมูลการอ่านค่าที่มีอยู่
- เติมแบบฟอร์มล่วงหน้าด้วยค่าปัจจุบัน
- แสดงข้อมูลการอ่านค่า (ID, เวลา, created_at)

**คำขอ POST:**

- ตรวจสอบข้อมูลแบบฟอร์มที่อัปเดต
- อัปเดตเรคอร์ดฐานข้อมูล
- รักษาเวลาดั้งเดิม
- เปลี่ยนเส้นทางไปยังรายละเอียดอุปกรณ์

**คุณสมบัติ:**

- แบบฟอร์มที่เติมข้อมูลที่มีอยู่ล่วงหน้า
- ตัวเลือกลบจากหน้าแก้ไข
- การรักษาเวลา
- การตรวจสอบ JSON สำหรับข้อมูลเซนเซอร์

**การดำเนินการฐานข้อมูล:**
```sql
-- ดึงการอ่านค่าที่มีอยู่
SELECT * FROM iot_readings WHERE id = %s

-- อัปเดตการอ่านค่า
UPDATE iot_readings SET device_id = %s, temperature = %s, 
       humidity = %s, sensor_data = %s WHERE id = %s
```

**ขั้นตอนการใช้งาน:** รายละเอียดอุปกรณ์ → แก้ไขการอ่านค่า → อัปเดต/ยกเลิก → รายละเอียดอุปกรณ์

---

### 6. ลบการอ่านค่า (`/delete/<reading_id>`)

**เส้นทาง:** `POST /delete/<reading_id>`  
**ฟังก์ชัน:** `delete_reading(reading_id)`  
**วัตถุประสงค์:** ลบการอ่านค่าเซนเซอร์ IoT เฉพาะ

**คุณสมบัติ:**

- กล่องโต้ตอบยืนยันก่อนลบ
- เปลี่ยนเส้นทางไปยังรายละเอียดอุปกรณ์หลังลบ
- ข้อความแฟลชยืนยัน

**การดำเนินการฐานข้อมูล:**
```sql
-- ตรวจสอบว่าการอ่านค่ามีอยู่
SELECT device_id FROM iot_readings WHERE id = %s

-- ลบการอ่านค่า
DELETE FROM iot_readings WHERE id = %s
```

**ขั้นตอนการใช้งาน:** รายละเอียดอุปกรณ์/แก้ไข → ยืนยันการลบ → รายละเอียดอุปกรณ์

---

### 7. หน้าข้อผิดพลาด (`/error`)

**เทมเพลต:** `templates/error.html`  
**วัตถุประสงค์:** แสดงข้อความข้อผิดพลาดพร้อมตัวเลือกการนำทาง

**คุณสมบัติ:**

- การแสดงข้อความข้อผิดพลาด
- การนำทางกลับไปยังหน้าแรกหรืออุปกรณ์
- สไตล์ที่สอดคล้องกับ UI หลัก

---

## API Endpoints

### 1. หน้าแรก API (`/api`)

**เส้นทาง:** `GET /api`  
**ฟังก์ชัน:** `api_home()`  
**วัตถุประสงค์:** endpoint ข้อมูล API พื้นฐาน

**การตอบสนอง:**
```json
{
    "message": "IoT Data Collection API",
    "status": "running", 
    "version": "1.0.0"
}
```

**กรณีการใช้งาน:** ตรวจสอบสถานะ API และข้อมูลเวอร์ชัน

---

### 2. รับข้อมูล IoT (`/api/data`)

**เส้นทาง:** `POST /api/data`  
**ฟังก์ชัน:** `receive_iot_data()`  
**วัตถุประสงค์:** endpoint หลักสำหรับอุปกรณ์ IoT ในการส่งข้อมูลเซนเซอร์

**รูปแบบคำขอ:**
```json
{
    "device_id": "device_001",
    "temperature": 25.5,
    "humidity": 60.2,
    "sensor_data": {
        "light": 750,
        "pressure": 1013.25
    }
}
```

**การตอบสนอง (สำเร็จ):**
```json
{
    "message": "Data received successfully",
    "device_id": "device_001",
    "timestamp": "2025-08-15T10:30:45"
}
```

**การตรวจสอบ:**

- `device_id`: สตริงจำเป็น
- `temperature`: ทศนิยมไม่บังคับ
- `humidity`: ทศนิยมไม่บังคับ
- `sensor_data`: วัตถุ JSON ไม่บังคับ

**การดำเนินการฐานข้อมูล:**
```sql
INSERT INTO iot_readings (device_id, temperature, humidity, sensor_data)
VALUES (%s, %s, %s, %s)
```

**กรณีการใช้งาน:** อุปกรณ์ MicroPython, เซนเซอร์ IoT, การเก็บข้อมูลอัตโนมัติ

---

### 3. ดึงการอ่านค่าอุปกรณ์ (`/api/data/<device_id>`)

**เส้นทาง:** `GET /api/data/<device_id>`  
**ฟังก์ชัน:** `get_device_data(device_id)`  
**วัตถุประสงค์:** ดึงการอ่านค่าสำหรับอุปกรณ์เฉพาะผ่าน API

**การตอบสนอง:**
```json
{
    "device_id": "device_001",
    "readings": [...],
    "count": 100
}
```

**คุณสมบัติ:**

- ส่งคืนการอ่านค่า 100 ครั้งล่าสุด
- เรียงตามเวลา (ใหม่ที่สุดก่อน)
- รูปแบบ JSON สำหรับการเข้าถึงแบบโปรแกรม

**กรณีการใช้งาน:** แอปพลิเคชันภายนอก, การวิเคราะห์ข้อมูล, แดชบอร์ดการตรวจสอบ

---

### 4. ตรวจสอบสุขภาพ (`/api/health`)

**เส้นทาง:** `GET /api/health`  
**ฟังก์ชัน:** `health_check()`  
**วัตถุประสงค์:** ตรวจสอบระบบและการเชื่อมต่อฐานข้อมูล

**การตอบสนอง (สุขภาพดี):**
```json
{
    "status": "healthy",
    "database": "connected"
}
```

**การตอบสนอง (สุขภาพไม่ดี):**
```json
{
    "status": "unhealthy", 
    "database": "disconnected"
}
```

**กรณีการใช้งาน:** ระบบตรวจสอบ, load balancers, การตรวจสอบสุขภาพ

---

## CRUD API Endpoints

### 1. สร้างการอ่านค่า (`POST /api/crud/reading`)

**ฟังก์ชัน:** `api_create_reading()`  
**วัตถุประสงค์:** การสร้างการอ่านค่าใหม่แบบโปรแกรม

**คำขอ:**
```json
{
    "device_id": "esp32_001",
    "temperature": 23.5,
    "humidity": 65.2,
    "sensor_data": {"battery": 85}
}
```

**การตอบสนอง:**
```json
{
    "success": true,
    "reading_id": 123,
    "message": "Reading created with ID 123"
}
```

---

### 2. อ่านการอ่านค่าเฉพาะ (`GET /api/crud/reading/<id>`)

**ฟังก์ชัน:** `api_read_reading(reading_id)`  
**วัตถุประสงค์:** ดึงการอ่านค่าเดียวตาม ID

**การตอบสนอง:**
```json
{
    "success": true,
    "reading": {
        "id": 123,
        "device_id": "esp32_001",
        "temperature": 23.5,
        "humidity": 65.2,
        "sensor_data": "{\"battery\": 85}",
        "timestamp": "2025-08-15T10:30:45",
        "created_at": "2025-08-15T10:30:45"
    }
}
```

---

### 3. อ่านการอ่านค่าทั้งหมด (`GET /api/crud/readings`)

**ฟังก์ชัน:** `api_read_all_readings()`  
**วัตถุประสงค์:** ดึงรายการการอ่านค่าทั้งหมดแบบแบ่งหน้า

**พารามิเตอร์คำค้นหา:**

- `limit`: จำนวนผลลัพธ์ (ค่าเริ่มต้น: 100)
- `offset`: ตำแหน่งเริ่มต้น (ค่าเริ่มต้น: 0)

**การตอบสนอง:**
```json
{
    "success": true,
    "readings": [...],
    "total": 1523,
    "limit": 100,
    "offset": 0
}
```

---

### 4. อ่านการอ่านค่าอุปกรณ์ (`GET /api/crud/device/<device_id>/readings`)

**ฟังก์ชัน:** `api_read_device_readings(device_id)`  
**วัตถุประสงค์:** ดึงการอ่านค่าแบบแบ่งหน้าสำหรับอุปกรณ์เฉพาะ

**พารามิเตอร์คำค้นหา:**

- `limit`: จำนวนผลลัพธ์ (ค่าเริ่มต้น: 100)
- `offset`: ตำแหน่งเริ่มต้น (ค่าเริ่มต้น: 0)

**การตอบสนอง:**
```json
{
    "success": true,
    "device_id": "esp32_001",
    "readings": [...],
    "total": 45,
    "limit": 100,
    "offset": 0
}
```

---

### 5. อัปเดตการอ่านค่า (`PUT /api/crud/reading/<id>`)

**ฟังก์ชัน:** `api_update_reading(reading_id)`  
**วัตถุประสงค์:** อัปเดตการอ่านค่าที่มีอยู่

**คำขอ:**
```json
{
    "temperature": 24.1,
    "humidity": 63.8,
    "sensor_data": {"battery": 83, "updated": true}
}
```

**การตอบสนอง:**
```json
{
    "success": true,
    "message": "Reading 123 updated successfully",
    "rows_affected": 1
}
```

---

### 6. ลบการอ่านค่า (`DELETE /api/crud/reading/<id>`)

**ฟังก์ชัน:** `api_delete_reading(reading_id)`  
**วัตถุประสงค์:** ลบการอ่านค่าเฉพาะ

**การตอบสนอง:**
```json
{
    "success": true,
    "message": "Reading 123 deleted successfully",
    "rows_affected": 1
}
```

---

### 7. ลบการอ่านค่าอุปกรณ์ (`DELETE /api/crud/device/<device_id>`)

**ฟังก์ชัน:** `api_delete_device_readings(device_id)`  
**วัตถุประสงค์:** ลบการอ่านค่าทั้งหมดสำหรับอุปกรณ์

**การตอบสนอง:**
```json
{
    "success": true,
    "message": "Deleted 45 readings for device esp32_001",
    "rows_affected": 45
}
```

---

## การดำเนินการฐานข้อมูล

### เมธอดคลาส IoTDataCRUD

#### `create_reading(device_id, temperature, humidity, sensor_data)`

**วัตถุประสงค์:** แทรกการอ่านค่าใหม่ลงในฐานข้อมูล  
**ส่งคืน:** สถานะความสำเร็จและ ID การอ่านค่า

#### `read_reading(reading_id)`

**วัตถุประสงค์:** ดึงการอ่านค่าเดียวตาม ID  
**ส่งคืน:** ข้อมูลการอ่านค่าหรือข้อผิดพลาด

#### `read_all_readings(limit, offset)`

**วัตถุประสงค์:** ดึงรายการการอ่านค่าทั้งหมดแบบแบ่งหน้า  
**ส่งคืน:** อาร์เรย์การอ่านค่าพร้อมข้อมูลการแบ่งหน้า

#### `read_device_readings(device_id, limit, offset)`

**วัตถุประสงค์:** ดึงการอ่านค่าแบบแบ่งหน้าสำหรับอุปกรณ์เฉพาะ  
**ส่งคืน:** การอ่านค่าอุปกรณ์พร้อมข้อมูลการแบ่งหน้า

#### `update_reading(reading_id, **kwargs)`

**วัตถุประสงค์:** อัปเดตการอ่านค่าที่มีอยู่ด้วยฟิลด์ที่ให้มา  
**ส่งคืน:** สถานะความสำเร็จและแถวที่ได้รับผลกระทบ

#### `delete_reading(reading_id)`

**วัตถุประสงค์:** ลบการอ่านค่าเดียวออกจากฐานข้อมูล  
**ส่งคืน:** สถานะความสำเร็จและแถวที่ได้รับผลกระทบ

#### `delete_device_readings(device_id)`

**วัตถุประสงค์:** ลบการอ่านค่าทั้งหมดสำหรับอุปกรณ์  
**ส่งคืน:** สถานะความสำเร็จและจำนวนที่ลบ

---

## โครงสร้างฐานข้อมูล

```sql
CREATE TABLE iot_readings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(100) NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    sensor_data JSON,
    temperature FLOAT,
    humidity FLOAT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ดัชนี:**

- Primary key บน `id`
- ดัชนีบน `device_id` สำหรับคำค้นหาอุปกรณ์
- ดัชนีบน `timestamp` สำหรับคำค้นหาตามเวลา

---

## การจัดการข้อผิดพลาด

### ข้อผิดพลาดเว็บอินเทอร์เฟซ

- **ข้อความแฟลช:** ข้อความข้อผิดพลาดภาษาไทยที่เป็นมิตรต่อผู้ใช้
- **การตรวจสอบแบบฟอร์ม:** การตรวจสอบฝั่งไคลเอ็นต์และฝั่งเซิร์ฟเวอร์
- **ข้อผิดพลาดฐานข้อมูล:** การกลับสู่สถานะปกติอย่างสง่างามด้วยหน้าข้อผิดพลาด
- **ข้อผิดพลาด 404:** เปลี่ยนเส้นทางไปยังหน้าที่เหมาะสม

### ข้อผิดพลาด API

- **400 Bad Request:** รูปแบบข้อมูลไม่ถูกต้องหรือขาดฟิลด์ที่จำเป็น
- **404 Not Found:** ไม่พบการอ่านค่าหรืออุปกรณ์
- **500 Internal Server Error:** ปัญหาการเชื่อมต่อฐานข้อมูล
- **503 Service Unavailable:** ฐานข้อมูลไม่พร้อมใช้งาน

### รูปแบบการตอบสนองข้อผิดพลาด

```json
{
    "success": false,
    "error": "คำอธิบายข้อผิดพลาด"
}
```

---

## ข้อควรพิจารณาด้านความปลอดภัย

### การตรวจสอบอินพุต

- การแยกวิเคราะห์ JSON พร้อมการจัดการข้อผิดพลาด
- การป้องกัน SQL injection โดยใช้คำค้นหาพารามิเตอร์
- การป้องกัน XSS ในเทมเพลต
- การป้องกัน CSRF ด้วยฟีเจอร์ที่มีอยู่ใน Flask

### ความปลอดภัยฐานข้อมูล

- การตรวจสอบพารามิเตอร์การเชื่อมต่อ
- การทำให้ข้อความข้อผิดพลาดปลอดภัย
- การยอนกลับธุรกรรมเมื่อมีข้อผิดพลาด

### การจำกัดอัตรา

- พิจารณาการใช้งานสำหรับการใช้งานจริง
- โดยเฉพาะสำหรับ API endpoints ที่รับข้อมูล IoT

---

## การปรับปรุงประสิทธิภาพ

### คำค้นหาฐานข้อมูล

- การแบ่งหน้าสำหรับชุดข้อมูลขนาดใหญ่
- ดัชนีบนคอลัมน์ที่ค้นหาบ่อย
- การรวมการเชื่อมต่อสำหรับการเข้าชมสูง

### การแคช

- การแคชไฟล์แบบคงที่สำหรับ CSS/JS
- การแคชเทมเพลตสำหรับการเรนเดอร์ซ้ำ
- การแคชการตอบสนอง API สำหรับการดำเนินการอ่านหนัก

### การตรวจสอบ

- endpoint ตรวจสอบสุขภาพสำหรับการตรวจสอบระบบ
- การตรวจสอบการเชื่อมต่อฐานข้อมูล
- การบันทึกข้อผิดพลาดและการแจ้งเตือน

---

เอกสารนี้ครอบคลุม endpoints และหน้าเว็บทั้งหมดในระบบจัดการข้อมูล IoT ด้วย Flask ให้นักพัฒนาและผู้ใช้มีความเข้าใจที่ครอบคลุมเกี่ยวกับฟังก์ชันการทำงานของระบบและรูปแบบการใช้งาน
